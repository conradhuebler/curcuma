# CLAUDE.md - Curcuma Development Guide

**⚠️ GENERATED BY CLAUDE AI - REQUIRES CURATION ⚠️**

*This document was automatically generated by Claude during development session on July 16, 2025. The information may contain inaccuracies and should be reviewed and corrected by human developers before being used as authoritative documentation.*

## Overview

**Curcuma** is a comprehensive molecular modelling and simulation toolkit written in C++ with a focus on computational chemistry, force field methods, and quantum chemical calculations. This document provides essential information for development, debugging, and extending the codebase.

## General instructions

- Each source code dir has a CLAUDE.md with basic informations of the code, the corresponding knowledge and logic in the directory 
- If a file is not present or outdated, create or update it
- Task corresponding to code have to be placed in the correct CLAUDE.md file
- Each CLAUDE.md may contain a variable part, where short-term information, bugs etc things are stored. Obsolete information have to be removed
- Each CLAUDE.md has a preserved part, which should no be edited by CLAUDE, only created if not present
- Each CLAUDE.md may contain an **instructions block** filled by the operator/programmer and from CLAUDE if approved with future tasks and visions that must be considered during code development
- Each CLAUDE.md file content should be important for ALL subdirectories
- If new knowledge is obtained from Claude Code Conversation preserve it in the CLAUDE.md files
- Always give improvments to existing code

## Development Guidelines

### Code Organization
- Each `src/` subdirectory contains detailed CLAUDE.md documentation
- Variable sections updated regularly with short-term information
- Preserved sections contain permanent knowledge and patterns
- Instructions blocks contain operator-defined future tasks and visions

### Implementation Standards
- Mark new functions as "Claude Generated" for traceability
- Document new functions briefly (doxygen ready)
- Document existing undocumented functions if appearing regulary (briefly and doxygen ready)
- Remove TODO Hashtags and text if done and approved
- Implement comprehensive error handling and logging 
- Maintain backward compatibility where possible
- **Always check and consider instructions blocks** in relevant CLAUDE.md files before implementing 
- reformulate and clarify task and vision entries if not alredy marked as CLAUDE formatted
- in case of compiler warning for deprecated functions, replace the old function call with the new one
- Implement timing analysis for complex funtions

## Current Capabilities

### 1. Quantum Mechanical Methods
- **Extended Hückel Theory (EHT)** - Semi-empirical quantum chemistry
- **TBLite Interface** - Tight-binding DFT methods (GFN1, GFN2, iPEA1)
- **XTB Interface** - Extended tight-binding methods (GFN-FF, GFN1, GFN2)
- **Ulysses Interface** - Various semi-empirical methods (PM3, AM1, MNDO, etc.)
- **Native GFN-FF** - Curcuma's own implementation (`cgfnff`) - *WORK IN PROGRESS*

### 2. Force Field Methods
- **Universal Force Field (UFF)** - General-purpose molecular mechanics
- **GFN-FF** - Geometry/Frequency/Noncovalent Force Field (via XTB and native)
- **QMDFF** - Quantum Mechanically Derived Force Fields
- **Universal Parameter Caching** - Automatic save/load for all FF methods

### 3. Dispersion and Non-Covalent Corrections
- **DFT-D3** - Grimme's D3 dispersion correction
- **DFT-D4** - Next-generation D4 dispersion correction  
- **H4 Correction** - Hydrogen bonding and halogen bonding corrections

### 4. Geometry Optimization
- **LBFGS Optimizer** - Limited-memory Broyden-Fletcher-Goldfarb-Shanno
- **Multiple Convergence Criteria** - Energy, gradient, RMSD-based
- **Constrained Optimization** - Distance, angle, and dihedral constraints

### 5. Conformational Analysis
- **ConfSearch** - Systematic conformational searching
- **ConfScan** - Conformational scanning along reaction coordinates
- **RMSD Analysis** - Structure comparison and alignment
- **Energy-based Filtering** - Automatic conformer ranking

### 6. Molecular Dynamics
- **SimpleMD** - Basic molecular dynamics simulation
- **NEB Docking** - Nudged elastic band for transition states
- **Trajectory Analysis** - Analysis of MD trajectories

### 7. Analysis Tools
- **RMSD Calculations** - Root-mean-square deviation analysis
- **Persistent Diagram** - Topological data analysis
- **Hessian Analysis** - Second derivative calculations
- **Orbital Analysis** - Molecular orbital visualization and analysis

## Architecture

### Core Components

#### Energy Calculator (`src/core/energycalculator.h/cpp`)
Central hub for all energy and gradient calculations. Routes method calls to appropriate interfaces:

```cpp
// Method routing via SwitchMethod()
case 9: GFNFF (cgfnff)           // Native GFN-FF implementation
case 6: EHT                      // Extended Hückel Theory  
case 4: DFT-D3                   // Dispersion corrections
case 3: Ulysses                  // Semi-empirical methods
case 2: XTB                      // Extended tight-binding
case 1: TBLite                   // Tight-binding DFT
case 0: ForceField               // UFF, QMDFF, etc.
```

#### Force Field System (`src/core/forcefield.h/cpp`)
Modern force field engine with:
- **Multi-threading support** via `ForceFieldThread`
- **Universal parameter caching** - automatic save/load as JSON
- **Method-aware loading** - validates parameter compatibility
- **Multi-threading safety** - controllable caching for concurrent calculations

#### QM Interface (`src/core/qm_methods/interface/abstract_interface.h`)
Unified interface for all quantum mechanical methods:
```cpp
class QMInterface {
    virtual bool InitialiseMolecule() = 0;
    virtual double Calculation(bool gradient, bool verbose) = 0;
    virtual bool hasGradient() const = 0;
    virtual Vector Charges() const = 0;
    virtual Vector BondOrders() const = 0;
};
```

### File Organization

```
curcuma/
├── src/
│   ├── capabilities/          # High-level molecular modeling tasks
│   │   ├── confscan.cpp      # Conformational scanning
│   │   ├── confsearch.cpp    # Conformational searching  
│   │   ├── curcumaopt.cpp    # Geometry optimization
│   │   ├── simplemd.cpp      # Molecular dynamics
│   │   └── rmsd.cpp          # Structure analysis
│   ├── core/                 # Core computational engines
│   │   ├── energycalculator.cpp  # Energy/gradient dispatcher
│   │   ├── forcefield.cpp        # Force field engine
│   │   ├── forcefieldthread.cpp  # Parallel FF calculations
│   │   ├── molecule.cpp          # Molecular data structures
│   │   └── qm_methods/           # Quantum chemistry interfaces
│   │       ├── gfnff.cpp         # Native GFN-FF implementation
│   │       ├── eht.cpp           # Extended Hückel Theory
│   │       ├── xtbinterface.cpp  # XTB interface
│   │       └── tbliteinterface.cpp # TBLite interface
│   ├── tools/                # Utilities and file I/O
│   │   ├── formats.h         # File format handling (XYZ, MOL2, SDF)
│   │   └── geometry.h        # Geometric calculations
│   └── helpers/              # Development and testing tools
├── test_cases/               # Validation and benchmark molecules
├── external/                 # Third-party dependencies
└── CMakeLists.txt           # Build configuration
```

## Recent Developments (July 2025)

### Native GFN-FF Implementation
- **Status**: WORK IN PROGRESS - Architecture complete, debugging needed
- **Method name**: `cgfnff` (curcuma-gfnff) vs `gfnff` (XTB-gfnff)
- **Integration**: Fully integrated in EnergyCalculator as case 9
- **Current issue**: JSON parameter generation bug (null values)

### Universal Parameter Caching 
- **Status**: COMPLETED and WORKING
- **Auto-naming**: `input.xyz` → `input.param.json`
- **Method validation**: Prevents loading incompatible parameters
- **Multi-threading safety**: `setParameterCaching(false)` for concurrent access
- **Performance**: 96% speedup demonstrated

## Build and Test Commands

```bash
# Build
mkdir build && cd build
cmake .. && make -j4

# Test UFF (working)
./curcuma -sp input.xyz -method uff

# Test native GFN-FF (work in progress)  
./curcuma -sp input.xyz -method cgfnff
```

## Curcuma Development Standards

### Logging and Output System

#### Verbosity Levels (0-3)
**All modules must implement 4-tier verbosity system:**
- **0 (Silent)**: Keine Ausgaben außer kritische Fehler und wichtigste Endergebnisse
- **1 (Small Print)**: Nur wichtige Endergebnisse, minimal formatiert, für Batch-Jobs, Includes nicely formatted input/arguments parameter (json structure)
- **2 (Normal Print)**: Standard-Fortschrittsinformationen, schön formatiert, Default für interaktive Nutzung
- **3 (Informative Print)**: Detaillierte Informationen mit vollem Styling für Debugging und Analyse, auch Timing Analysen

#### Farb-Schema und Formatierung
**Einheitliche Farbkodierung für alle Ausgaben:**
- **Fehler/Errors**: `fmt::color::red` - Immer sichtbar, unabhängig von Verbosity
- **Warnungen/Warnings**: `fmt::color::orange` - Ab Level 1
- **Erfolg/Status**: `fmt::color::lime_green` - Wichtige positive Meldungen
- **Zitationshinweise**: `fmt::color::green` - Literaturverweise und Credits
- **Parameter/Werte**: `fmt::color::blue` - Konfiguration und numerische Werte
- **Info/Standard**: Terminal-Default - Normale Informationen
- **Debug**: `fmt::color::magenta` - Debug-Ausgaben (nur bei CURCUMA_DEBUG)

#### Output-Modi
- **RAW Mode**: Keine Farben, maschinenlesbar (`CURCUMA_NO_COLOR=1` oder `--no-color`)
- **TERMINAL Mode**: Vollfarben für interaktive Nutzung (Default)
- **MARKDOWN Mode**: Optional für Reports (`--output-format=markdown`)

#### Logging-Makros (zu implementieren)
```cpp
// Produktions-Logging (immer verfügbar)
CURCUMA_ERROR(message)                // Rot, immer sichtbar
CURCUMA_WARN(message)                 // Orange, ab Level 1  
CURCUMA_SUCCESS(message)              // Grün, ab Level 1
CURCUMA_INFO(message)                 // Standard, ab Level 2
CURCUMA_PARAM(key, value)             // Blau, ab Level 2
CURCUMA_CITATION(reference)           // Grün, ab Level 2
CURCUMA_RESULT_RAW(data)              // Unformatiert für Scripting
CURCUMA_PROGRESS(current, total, msg) // Fortschrittsbalken ab Level 2
CURCUMA_HEADER(title)                 // Section-Header ab Level 2

// Debug-Logging (nur bei CURCUMA_DEBUG build, compile-time eliminiert)
CURCUMA_DEBUG(level, message)         // Magenta, Debug-Level 0-3
CURCUMA_DEBUG_VAR(variable)           // Variable dump
CURCUMA_DEBUG_TIMING(label)           // Performance-Messungen
```

#### Debug-System (Build-Zeit-Kontrolle)
- **CMake Option**: `option(CURCUMA_DEBUG "Enable debug output" OFF)`
- **Makro**: `#ifdef CURCUMA_DEBUG` für vollständige compile-time Eliminierung
- **Performance**: Debug-Code nimmt in Release-Builds KEINE Rechenleistung
- **Debug-Level**: 0-3 für verschiedene Debug-Detailgrade

### Unit System and Conversions

#### Internal Unit System (Atomic Units)
**Alle Rechnungen intern in atomaren Einheiten:**
- **Energie**: Hartree (Eh) - 1 Eh = 27.211386245988 eV = 2625.4996394798 kJ/mol
- **Länge**: Bohr (a₀) - 1 a₀ = 0.529177210903 Å  
- **Zeit**: Atomare Zeit (aut) - 1 aut = 24.188843265857 fs
- **Masse**: Elektronenmasse (mₑ) - für relative Atommassen
- **Temperatur**: Kelvin - direkt verwendbar
- **Ladung**: Elementarladung (e) - direkt verwendbar

#### Output Unit Preferences
**Benutzerfreundliche Ausgaben mit automatischer Einheitenwahl:**

**Energien:**
- **Absolute Energien**: Hartree (Eh) - für QM-Rechnungen
- **Relative Energien**: kJ/mol - für thermodynamische Größen
- **Kleine Energiedifferenzen**: meV oder cm⁻¹ - für Spektroskopie
- **Aktivierungsbarrieren**: kcal/mol - für Kinetik

**Geometrien:**
- **Atomabstände**: Ångström (Å) - Standard in Molekülchemie
- **Große Systeme**: nm - für Biomoleküle
- **Zellparameter**: Å oder pm - je nach Größe

**Zeit/Dynamik:**
- **MD-Schritte**: fs - Femtosekunden für Molekulardynamik
- **Reaktionszeiten**: ps, ns - je nach Zeitskala
- **Optimierung**: Anzahl Zyklen - dimensionslos

#### Automatische Unit Conversion Functions (zu implementieren)
```cpp
// Energy conversions
double hartree_to_kjmol(double eh);
double hartree_to_kcalmol(double eh);
double hartree_to_ev(double eh);  
double hartree_to_wavenumber(double eh); // cm⁻¹

// Length conversions  
double bohr_to_angstrom(double bohr);
double angstrom_to_bohr(double ang);

// Smart formatting with automatic unit selection
std::string format_energy_relative(double eh_diff); // Auto: kJ/mol, meV, cm⁻¹
std::string format_energy_absolute(double eh);      // Always Hartree
std::string format_length(double bohr);             // Auto: Å, pm, nm
std::string format_time(double aut);                // Auto: fs, ps, ns

// Unit-aware output macros
CURCUMA_ENERGY_REL(value_eh, label);  // Automatisch kJ/mol mit Einheit
CURCUMA_ENERGY_ABS(value_eh, label);  // Hartree mit Einheit  
CURCUMA_LENGTH(value_bohr, label);    // Ångström mit Einheit
CURCUMA_TIME(value_aut, label);       // fs/ps mit Einheit
```

#### Physical Constants (Internal Reference)
```cpp
// Fundamental constants in atomic units
const double SPEED_OF_LIGHT_AU = 137.035999084;     // c in a.u.
const double BOLTZMANN_AU = 3.1668115634556e-6;     // kB in Eh/K
const double AVOGADRO = 6.02214076e23;              // mol⁻¹

// Conversion factors (exact values)
const double EH_TO_KJMOL = 2625.4996394798;
const double EH_TO_KCALMOL = 627.5094740631;  
const double EH_TO_EV = 27.211386245988;
const double EH_TO_WAVENUMBER = 219474.6313632;     // cm⁻¹
const double BOHR_TO_ANGSTROM = 0.529177210903;
const double AUT_TO_FS = 24.188843265857;
```

#### Implementation Guidelines
- **Konsistenz**: Alle Module verwenden dieselben Umrechnungsfunktionen
- **Präzision**: Verwende CODATA-2018 Werte für physikalische Konstanten  
- **Automatik**: Intelligente Einheitenwahl basierend auf Wertebereichen
- **Klarheit**: Immer Einheiten in Ausgaben anzeigen
- **Kompatibilität**: Input/Output kann verschiedene Einheiten akzeptieren

## Known Issues

1. **cgfnff JSON bug**: Parameter generation creates null values causing crashes
2. **Missing real GFN-FF parameters**: Currently uses placeholder values  
3. **Logging system**: Needs complete overhaul to new standards above
4. **Unit inconsistencies**: Mixed unit usage throughout codebase needs standardization

---

**DISCLAIMER**: This documentation was generated by Claude AI and may contain errors, omissions, or misunderstandings about the codebase. Please review, correct, and update as needed.

**Generated**: July 16, 2025 by Claude  
**Status**: DRAFT - Requires human curation